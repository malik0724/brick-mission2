<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Brick Mission Stable - Complete</title>
<style>
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body {
  font-family: 'Arial', sans-serif;
  background: #000;
  overflow: hidden;
  width: 100vw;
  height: 100vh;
  touch-action: none;
}

#gameContainer {
  width: 100%;
  height: 100%;
  position: relative;
  background: linear-gradient(to bottom, #000011, #001122);
}

canvas {
  display: block;
  width: 100%;
  height: 100%;
}

.border {
  position: absolute;
  z-index: 100;
}

.top-border {
  top: 0;
  left: 0;
  width: 100%;
  height: 10px;
  background: linear-gradient(90deg, 
    #ff00ff, #00ffff, #ffff00, #ff0000, #00ff00, #ff00ff);
  background-size: 300% 100%;
  animation: borderMove 3s linear infinite;
  box-shadow: 0 5px 15px rgba(0, 255, 255, 0.5);
}

.bottom-border {
  bottom: 0;
  left: 0;
  width: 100%;
  height: 10px;
  background: linear-gradient(90deg, 
    #00ff00, #ff00ff, #ffff00, #00ffff, #ff0000, #00ff00);
  background-size: 300% 100%;
  animation: borderMove 3s linear infinite reverse;
  box-shadow: 0 -5px 15px rgba(255, 0, 255, 0.5);
}

.left-border {
  top: 0;
  left: 0;
  width: 10px;
  height: 100%;
  background: linear-gradient(0deg, 
    #ff0000, #00ff00, #00ffff, #ffff00, #ff00ff, #ff0000);
  background-size: 100% 300%;
  animation: borderMoveVertical 3s linear infinite;
  box-shadow: 5px 0 15px rgba(255, 255, 0, 0.5);
}

.right-border {
  top: 0;
  right: 0;
  width: 10px;
  height: 100%;
  background: linear-gradient(0deg, 
    #00ffff, #ffff00, #ff00ff, #ff0000, #00ff00, #00ffff);
  background-size: 100% 300%;
  animation: borderMoveVertical 3s linear infinite reverse;
  box-shadow: -5px 0 15px rgba(0, 255, 255, 0.5);
}

@keyframes borderMove {
  0% { background-position: 0% 0%; }
  100% { background-position: 300% 0%; }
}

@keyframes borderMoveVertical {
  0% { background-position: 0% 0%; }
  100% { background-position: 0% 300%; }
}

#gameUI {
  position: absolute;
  top: 20px;
  left: 0;
  width: 100%;
  display: flex;
  justify-content: space-between;
  padding: 0 20px;
  z-index: 50;
}

.ui-panel {
  background: rgba(0, 20, 40, 0.9);
  border: 2px solid #00ffff;
  border-radius: 10px;
  padding: 10px 20px;
  box-shadow: 0 0 20px rgba(0, 255, 255, 0.5);
}

.ui-item {
  color: #00ffff;
  font-size: 18px;
  margin: 5px 0;
  text-shadow: 0 0 5px rgba(0, 255, 255, 0.7);
}

.ui-value {
  color: #ffff00;
  font-weight: bold;
  margin-left: 5px;
}

#shootingMachine {
  position: absolute;
  bottom: 150px;
  left: 50%;
  transform: translateX(-50%);
  width: 140px;
  height: 60px;
  background: linear-gradient(to bottom, #333, #111);
  border: 3px solid #00ffff;
  border-radius: 30px;
  box-shadow: 0 0 30px rgba(0, 255, 255, 0.7);
  z-index: 40;
  display: flex;
  align-items: center;
  justify-content: center;
}

.shooting-barrel {
  width: 35px;
  height: 35px;
  background: radial-gradient(circle, #ffaa00, #ff5500);
  border-radius: 50%;
  box-shadow: 0 0 20px rgba(255, 170, 0, 0.8);
  animation: barrelPulse 1.5s infinite alternate;
}

@keyframes barrelPulse {
  0% { transform: scale(1); opacity: 0.8; }
  100% { transform: scale(1.1); opacity: 1; }
}

.controls {
  position: absolute;
  bottom: 30px;
  right: 30px;
  display: flex;
  gap: 15px;
  z-index: 50;
}

.control-btn {
  width: 70px;
  height: 70px;
  background: linear-gradient(135deg, #002244, #004488);
  border: 3px solid #00ffff;
  border-radius: 50%;
  color: #00ffff;
  font-size: 30px;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  box-shadow: 0 0 20px rgba(0, 255, 255, 0.5);
  transition: all 0.3s;
  user-select: none;
}

.control-btn:hover {
  transform: scale(1.1);
  box-shadow: 0 0 30px rgba(0, 255, 255, 0.8);
}

.menu {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: rgba(0, 20, 40, 0.95);
  border: 3px solid #00ffff;
  border-radius: 20px;
  padding: 30px;
  z-index: 200;
  min-width: 400px;
  text-align: center;
  display: none;
  box-shadow: 0 0 50px rgba(0, 255, 255, 0.7);
  backdrop-filter: blur(5px);
}

.menu h2 {
  color: #00ffff;
  margin-bottom: 20px;
  font-size: 32px;
  text-shadow: 0 0 10px rgba(0, 255, 255, 0.7);
}

.menu p {
  color: white;
  margin: 15px 0;
  font-size: 18px;
}

.menu-btn {
  background: linear-gradient(145deg, #002244, #004488);
  border: 2px solid #00aaff;
  border-top: 2px solid #00ffff;
  border-left: 2px solid #00ffff;
  border-right: 2px solid #0055aa;
  border-bottom: 2px solid #0055aa;
  color: #00ffff;
  padding: 15px 30px;
  border-radius: 10px;
  font-size: 20px;
  cursor: pointer;
  transition: all 0.3s;
  margin: 10px;
  min-width: 200px;
  box-shadow: 
    4px 4px 8px rgba(0, 0, 0, 0.5),
    -2px -2px 4px rgba(255, 255, 255, 0.1),
    inset 2px 2px 4px rgba(0, 170, 255, 0.3),
    inset -2px -2px 4px rgba(0, 0, 0, 0.5);
  position: relative;
  overflow: hidden;
}

.menu-btn:hover {
  background: linear-gradient(145deg, #003366, #0055aa);
  transform: translateY(-2px);
  box-shadow: 
    6px 6px 10px rgba(0, 0, 0, 0.6),
    -3px -3px 6px rgba(255, 255, 255, 0.15),
    inset 2px 2px 4px rgba(0, 170, 255, 0.4),
    inset -2px -2px 4px rgba(0, 0, 0, 0.6);
}

.menu-btn:active {
  transform: translateY(1px);
  box-shadow: 
    2px 2px 4px rgba(0, 0, 0, 0.5),
    -1px -1px 2px rgba(255, 255, 255, 0.1),
    inset 4px 4px 8px rgba(0, 0, 0, 0.5),
    inset -2px -2px 4px rgba(0, 170, 255, 0.3);
}

.ability-btn {
  background: linear-gradient(145deg, #442200, #884400);
  border: 2px solid #ffaa00;
  border-top: 2px solid #ffff00;
  border-left: 2px solid #ffff00;
  border-right: 2px solid #aa5500;
  border-bottom: 2px solid #aa5500;
  color: #ffff00;
  box-shadow: 
    4px 4px 8px rgba(0, 0, 0, 0.5),
    -2px -2px 4px rgba(255, 255, 255, 0.1),
    inset 2px 2px 4px rgba(255, 170, 0, 0.3),
    inset -2px -2px 4px rgba(0, 0, 0, 0.5);
}

.ability-btn:hover {
  background: linear-gradient(145deg, #663300, #aa6600);
  box-shadow: 
    6px 6px 10px rgba(0, 0, 0, 0.6),
    -3px -3px 6px rgba(255, 255, 255, 0.15),
    inset 2px 2px 4px rgba(255, 170, 0, 0.4),
    inset -2px -2px 4px rgba(0, 0, 0, 0.6);
}

.level-btn {
  padding: 10px;
  background: linear-gradient(145deg, #002244, #004488);
  border: 2px solid #00aaff;
  border-top: 2px solid #00ffff;
  border-left: 2px solid #00ffff;
  border-right: 2px solid #0055aa;
  border-bottom: 2px solid #0055aa;
  color: #00ffff;
  border-radius: 5px;
  cursor: pointer;
  transition: all 0.2s;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  min-height: 70px;
  position: relative;
  box-shadow: 
    3px 3px 6px rgba(0, 0, 0, 0.4),
    -1px -1px 3px rgba(255, 255, 255, 0.1);
}

.level-btn:hover {
  background: linear-gradient(145deg, #003366, #0055aa);
  transform: scale(1.05) translateY(-2px);
  box-shadow: 
    5px 5px 8px rgba(0, 0, 0, 0.5),
    -2px -2px 4px rgba(255, 255, 255, 0.15);
}

.level-btn.locked {
  opacity: 0.5;
  cursor: not-allowed;
  border-color: #666;
  background: linear-gradient(145deg, #222222, #444444);
}

.level-btn.completed {
  background: linear-gradient(145deg, #004400, #006600);
  border-color: #00ff00;
  border-top: 2px solid #00ff00;
  border-left: 2px solid #00ff00;
  border-right: 2px solid #003300;
  border-bottom: 2px solid #003300;
}

.stars-container {
  display: flex;
  justify-content: center;
  gap: 20px;
  margin: 20px 0;
}

.star {
  width: 50px;
  height: 50px;
  background: #ffaa00;
  clip-path: polygon(
    50% 0%,
    61% 35%,
    98% 35%,
    68% 57%,
    79% 91%,
    50% 70%,
    21% 91%,
    32% 57%,
    2% 35%,
    39% 35%
  );
  opacity: 0.3;
  transform: scale(0.8);
  transition: all 0.5s;
}

.star.active {
  opacity: 1;
  transform: scale(1);
  animation: starGlow 1s infinite alternate;
}

@keyframes starGlow {
  0% { filter: drop-shadow(0 0 5px #ffaa00); }
  100% { filter: drop-shadow(0 0 20px #ffaa00); }
}

@keyframes starEarned {
  0% { transform: scale(0) rotate(0deg); }
  50% { transform: scale(1.2) rotate(180deg); }
  100% { transform: scale(1) rotate(360deg); }
}

.star.earned {
  animation: starEarned 0.8s ease-out forwards;
}

#ballCounter {
  position: absolute;
  bottom: 220px;
  left: 50%;
  transform: translateX(-50%);
  color: #ffff00;
  font-size: 18px;
  background: rgba(0, 0, 0, 0.7);
  padding: 8px 20px;
  border-radius: 15px;
  border: 2px solid #ffff00;
  z-index: 45;
}

#levelSelectContainer {
  max-height: 300px;
  overflow-y: auto;
  margin: 20px 0;
  padding: 10px;
  background: rgba(0, 0, 0, 0.3);
  border-radius: 10px;
  border: 2px solid #00ffff;
}

.level-grid {
  display: grid;
  grid-template-columns: repeat(5, 1fr);
  gap: 10px;
}

.level-number {
  font-size: 18px;
  font-weight: bold;
  margin-bottom: 5px;
}

.level-stars {
  display: flex;
  gap: 3px;
  margin-top: 5px;
}

.level-star {
  width: 15px;
  height: 15px;
  background: #ffaa00;
  clip-path: polygon(
    50% 0%,
    61% 35%,
    98% 35%,
    68% 57%,
    79% 91%,
    50% 70%,
    21% 91%,
    32% 57%,
    2% 35%,
    39% 35%
  );
  opacity: 0.8;
}

.level-star.empty {
  opacity: 0.3;
}

.lock-icon {
  font-size: 24px;
  margin-bottom: 5px;
}

.unlock-animation {
  animation: unlockLevel 0.5s ease-out;
}

@keyframes unlockLevel {
  0% { transform: scale(0.5); opacity: 0; }
  50% { transform: scale(1.2); opacity: 1; }
  100% { transform: scale(1); opacity: 1; }
}

#shootingGuide {
  position: absolute;
  bottom: 270px;
  left: 50%;
  transform: translateX(-50%);
  color: #00ffff;
  font-size: 14px;
  background: rgba(0, 0, 0, 0.7);
  padding: 5px 15px;
  border-radius: 10px;
  border: 2px solid #00ffff;
  z-index: 45;
  opacity: 0.8;
}

.level-progress {
  position: absolute;
  top: 90px;
  left: 50%;
  transform: translateX(-50%);
  width: 80%;
  height: 10px;
  background: rgba(0, 0, 0, 0.5);
  border-radius: 5px;
  border: 1px solid #00ffff;
  overflow: hidden;
  z-index: 45;
}

.progress-fill {
  height: 100%;
  background: linear-gradient(90deg, #00ff00, #ffff00);
  width: 0%;
  transition: width 0.3s;
}

#gameStatus {
  position: absolute;
  top: 110px;
  left: 50%;
  transform: translateX(-50%);
  color: #00ffff;
  font-size: 16px;
  z-index: 45;
  text-align: center;
}
</style>
</head>
<body>
<div id="gameContainer">
  <canvas id="gameCanvas"></canvas>
  
  <div class="border top-border"></div>
  <div class="border bottom-border"></div>
  <div class="border left-border"></div>
  <div class="border right-border"></div>
  
  <div class="level-progress">
    <div class="progress-fill" id="progressFill"></div>
  </div>
  
  <div id="gameStatus">Ready to shoot!</div>
  
  <div id="gameUI">
    <div class="ui-panel">
      <div class="ui-item">LEVEL: <span id="levelDisplay" class="ui-value">1</span></div>
      <div class="ui-item">SHOTS: <span id="shotsDisplay" class="ui-value">0/5</span></div>
    </div>
    <div class="ui-panel">
      <div class="ui-item">SCORE: <span id="scoreDisplay" class="ui-value">0</span></div>
      <div class="ui-item">BRICKS: <span id="bricksDisplay" class="ui-value">0</span></div>
    </div>
  </div>
  
  <div id="shootingMachine">
    <div class="shooting-barrel"></div>
  </div>
  
  <div id="shootingGuide">Click/Drag to aim, Release to shoot</div>
  
  <div id="ballCounter">ACTIVE BALLS: <span id="activeBalls">0</span></div>
  
  <div class="controls">
    <div class="control-btn" id="abilitiesBtn" title="Abilities">âš¡</div>
    <div class="control-btn" id="menuBtn" title="Menu">â‰¡</div>
  </div>
</div>

<div class="menu" id="startMenu">
  <h2>BRICK MISSION STABLE</h2>
  <p>Destroy all bricks to advance!</p>
  <p style="color:#ffff00">Unlocked Levels: <span id="unlockedLevels">1</span>/1000</p>
  <div style="margin: 20px 0;">
    <button class="menu-btn" id="startBtn">NEW GAME</button>
    <button class="menu-btn" id="continueBtn">CONTINUE</button>
    <button class="menu-btn" id="levelSelectBtn">LEVEL SELECT</button>
    <button class="menu-btn" id="soundToggle">SOUND: ON</button>
  </div>
</div>

<div class="menu" id="levelMenu" style="display:none">
  <h2>SELECT LEVEL</h2>
  <p>Unlocked: <span id="maxUnlockedDisplay" style="color:#ffff00">1</span>/1000</p>
  <div id="levelSelectContainer">
    <div class="level-grid" id="levelGrid"></div>
  </div>
  <div style="margin-top: 20px;">
    <button class="menu-btn" id="backToMainBtn">BACK</button>
  </div>
</div>

<div class="menu" id="mainMenu" style="display:none">
  <h2>GAME MENU</h2>
  <div style="margin: 20px 0;">
    <button class="menu-btn" id="resumeBtn">RESUME</button>
    <button class="menu-btn" id="restartBtn">RESTART LEVEL</button>
    <button class="menu-btn" id="mainMenuBtn">MAIN MENU</button>
  </div>
</div>

<div class="menu" id="abilitiesMenu" style="display:none">
  <h2>ABILITIES</h2>
  <div style="margin: 20px 0;">
    <button class="menu-btn ability-btn" id="laserBtn">LASER BALL (<span id="laserCountDisplay">3</span>)</button>
    <button class="menu-btn ability-btn" id="fireballBtn">FIRE BALL (<span id="fireballCountDisplay">2</span>)</button>
    <button class="menu-btn ability-btn" id="multiballBtn">MULTI BALL (<span id="multiballCountDisplay">1</span>)</button>
    <button class="menu-btn" id="closeAbilitiesBtn">CLOSE</button>
  </div>
</div>

<div class="menu" id="completeMenu" style="display:none">
  <h2 style="color:#00ff00">LEVEL COMPLETE!</h2>
  <p>You cleared level <span id="completedLevel" style="color:#ffff00">1</span>!</p>
  <p>Shots Used: <span id="shotsUsed">0</span>/<span id="totalShots">5</span></p>
  <p>Rating:</p>
  <div class="stars-container">
    <div class="star" id="star1"></div>
    <div class="star" id="star2"></div>
    <div class="star" id="star3"></div>
  </div>
  <div style="margin-top: 20px;">
    <button class="menu-btn" id="nextLevelBtn">NEXT LEVEL</button>
    <button class="menu-btn" id="menuAfterCompleteBtn">MAIN MENU</button>
  </div>
</div>

<div class="menu" id="gameOverMenu" style="display:none">
  <h2 style="color:#ff0000">GAME OVER</h2>
  <p>You ran out of shots!</p>
  <p>Final Score: <span id="finalScore" style="color:#ffff00">0</span></p>
  <div style="margin-top: 20px;">
    <button class="menu-btn" id="restartGameBtn">RESTART LEVEL</button>
    <button class="menu-btn" id="menuAfterGameOverBtn">MAIN MENU</button>
  </div>
</div>

<script>
// ============================================
// COMPLETE WORKING GAME - FIXED VERSION
// ============================================

const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');

let audioContext;
let sounds = {};

function initAudio() {
  try {
    audioContext = new (window.AudioContext || window.webkitAudioContext)();
    createSounds();
  } catch (e) {
    console.log('Web Audio API not supported');
  }
}

function createSounds() {
  sounds.click = function() {
    if (!audioContext || !game.soundEnabled) return;
    
    const oscillator = audioContext.createOscillator();
    const gainNode = audioContext.createGain();
    
    oscillator.connect(gainNode);
    gainNode.connect(audioContext.destination);
    
    oscillator.frequency.value = 800;
    oscillator.type = 'sine';
    
    gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.1);
    
    oscillator.start();
    oscillator.stop(audioContext.currentTime + 0.1);
  };
  
  sounds.shoot = function() {
    if (!audioContext || !game.soundEnabled) return;
    
    const oscillator = audioContext.createOscillator();
    const gainNode = audioContext.createGain();
    
    oscillator.connect(gainNode);
    gainNode.connect(audioContext.destination);
    
    oscillator.frequency.value = 600;
    oscillator.type = 'sawtooth';
    
    gainNode.gain.setValueAtTime(0.4, audioContext.currentTime);
    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.2);
    
    oscillator.start();
    oscillator.stop(audioContext.currentTime + 0.2);
  };
  
  sounds.hit = function(pitch = 300) {
    if (!audioContext || !game.soundEnabled) return;
    
    const oscillator = audioContext.createOscillator();
    const gainNode = audioContext.createGain();
    
    oscillator.connect(gainNode);
    gainNode.connect(audioContext.destination);
    
    oscillator.frequency.value = pitch;
    oscillator.type = 'square';
    
    gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.15);
    
    oscillator.start();
    oscillator.stop(audioContext.currentTime + 0.15);
  };
  
  sounds.destroy = function() {
    if (!audioContext || !game.soundEnabled) return;
    
    for (let i = 0; i < 3; i++) {
      setTimeout(() => {
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();
        
        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);
        
        oscillator.frequency.value = 100 + i * 200;
        oscillator.type = 'triangle';
        
        gainNode.gain.setValueAtTime(0.2, audioContext.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.1);
        
        oscillator.start();
        oscillator.stop(audioContext.currentTime + 0.1);
      }, i * 50);
    }
  };
  
  sounds.unlock = function() {
    if (!audioContext || !game.soundEnabled) return;
    
    for (let i = 0; i < 4; i++) {
      setTimeout(() => {
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();
        
        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);
        
        oscillator.frequency.value = 300 + i * 100;
        oscillator.type = 'sine';
        
        gainNode.gain.setValueAtTime(0.2, audioContext.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.2);
        
        oscillator.start();
        oscillator.stop(audioContext.currentTime + 0.2);
      }, i * 100);
    }
  };
}

const game = {
  state: 'menu',
  currentLevel: 1,
  maxUnlockedLevel: 1,
  score: 0,
  shotsUsed: 0,
  totalShots: 5,
  balls: [],
  bricks: [],
  activeBalls: 0,
  totalBricks: 0,
  levelStars: {},
  aiming: false,
  aimAngle: -Math.PI / 2,
  aimX: 0,
  aimY: 0,
  canShoot: true,
  mouseDown: false,
  shootingQueue: [],
  isShootingQueueActive: false,
  ballReleaseTimer: 0,
  ballReleaseDelay: 3,
  abilities: {
    laser: { count: 3, active: false },
    fireball: { count: 2, active: false },
    multiball: { count: 1, active: false }
  },
  soundEnabled: true,
  levelSeed: 0,
  particles: []
};
    function initCanvas() {
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
}

function loadGameData() {
  const saved = localStorage.getItem('brickMissionSave');
  if (saved) {
    try {
      const data = JSON.parse(saved);
      game.maxUnlockedLevel = data.maxUnlockedLevel || 1;
      game.score = data.score || 0;
      game.levelStars = data.levelStars || {};
      updateUI();
    } catch (e) {
      console.log('Error loading save');
    }
  }
}

function saveGameData() {
  const data = {
    maxUnlockedLevel: game.maxUnlockedLevel,
    score: game.score,
    levelStars: game.levelStars
  };
  localStorage.setItem('brickMissionSave', JSON.stringify(data));
}

function updateUI() {
  document.getElementById('levelDisplay').textContent = game.currentLevel;
  document.getElementById('shotsDisplay').textContent = `${game.shotsUsed}/${game.totalShots}`;
  document.getElementById('scoreDisplay').textContent = game.score;
  document.getElementById('bricksDisplay').textContent = game.bricks.length;
  document.getElementById('unlockedLevels').textContent = game.maxUnlockedLevel;
  document.getElementById('maxUnlockedDisplay').textContent = game.maxUnlockedLevel;
  document.getElementById('activeBalls').textContent = game.activeBalls;
  
  if (game.totalBricks > 0) {
    const progress = ((game.totalBricks - game.bricks.length) / game.totalBricks) * 100;
    document.getElementById('progressFill').style.width = `${progress}%`;
  }
  
  if (game.state === 'playing') {
    if (game.activeBalls > 0) {
      document.getElementById('gameStatus').textContent = `${game.activeBalls} balls active`;
    } else if (game.canShoot) {
      document.getElementById('gameStatus').textContent = `Ready to shoot! (${game.totalShots - game.shotsUsed} shots left)`;
    } else if (game.isShootingQueueActive) {
      document.getElementById('gameStatus').textContent = `Releasing balls...`;
    } else {
      document.getElementById('gameStatus').textContent = 'Waiting...';
    }
  }
}

function updateAbilitiesMenu() {
  document.getElementById('laserCountDisplay').textContent = game.abilities.laser.count;
  document.getElementById('fireballCountDisplay').textContent = game.abilities.fireball.count;
  document.getElementById('multiballCountDisplay').textContent = game.abilities.multiball.count;
}

function seededRandom(seed) {
  let x = Math.sin(seed) * 10000;
  return x - Math.floor(x);
}

function createBricks() {
  game.bricks = [];
  game.levelSeed = game.currentLevel * 12345;
  
  const baseRows = 4;
  const baseCols = 6;
  const rowIncrease = Math.floor(game.currentLevel / 3);
  const colIncrease = Math.floor(game.currentLevel / 5);
  
  const rows = Math.min(8, baseRows + rowIncrease);
  const cols = Math.min(10, baseCols + colIncrease);
  
  const brickWidth = Math.min(70, (canvas.width - 40) / cols - 5);
  const brickHeight = 30;
  const startX = 30;
  const startY = 120;
  const baseHP = Math.min(99, game.currentLevel + 1);
  
  let brickCount = 0;
  
  for (let r = 0; r < rows; r++) {
    for (let c = 0; c < cols; c++) {
      const seed = game.levelSeed + r * 100 + c;
      const rand = seededRandom(seed);
      
      if (rand > 0.3) {
        const hp = Math.min(99, baseHP + r + Math.floor(game.currentLevel / 2));
        const h = Math.min(120, 120 - (hp * 1.2));
        
        const brick = {
          x: startX + c * (brickWidth + 5),
          y: startY + r * (brickHeight + 5),
          width: brickWidth,
          height: brickHeight,
          hp: hp,
          maxHP: hp,
          h: h,
          s: 100,
          l: 50,
          color: `hsl(${h}, 100%, 50%)`,
          topColor: `hsl(${h}, 100%, 70%)`,
          sideColor: `hsl(${h}, 100%, 30%)`,
          shadow: `hsl(${h}, 100%, 20%)`,
          hitTime: 0,
          wobble: 0,
          wobbleSpeed: 0,
          wobbleAngle: 0,
          isWobbling: false
        };
        game.bricks.push(brick);
        brickCount++;
      }
    }
  }
  
  game.totalBricks = brickCount;
  
  if (game.bricks.length < 5) {
    for (let i = 0; i < 8; i++) {
      const h = Math.min(120, 120 - (baseHP * 3));
      const brick = {
        x: canvas.width/2 - 180 + (i % 4) * 95,
        y: 150 + Math.floor(i / 4) * 45,
        width: 90,
        height: 30,
        hp: baseHP,
        maxHP: baseHP,
        h: h,
        s: 100,
        l: 50,
        color: `hsl(${h}, 100%, 50%)`,
        topColor: `hsl(${h}, 100%, 70%)`,
        sideColor: `hsl(${h}, 100%, 30%)`,
        shadow: `hsl(${h}, 100%, 20%)`,
        hitTime: 0,
        wobble: 0,
        wobbleSpeed: 0,
        wobbleAngle: 0,
        isWobbling: false
      };
      game.bricks.push(brick);
      game.totalBricks++;
    }
  }
    }
    function startLevel(level) {
  if (level > game.maxUnlockedLevel) {
    alert('Level locked! Complete previous levels to unlock.');
    return;
  }
  
  game.state = 'playing';
  game.currentLevel = level;
  game.shotsUsed = 0;
  game.totalShots = 5 + (level - 1);
  game.balls = [];
  game.bricks = [];
  game.activeBalls = 0;
  game.particles = [];
  game.aiming = false;
  game.canShoot = true;
  game.mouseDown = false;
  game.totalBricks = 0;
  game.shootingQueue = [];
  game.isShootingQueueActive = false;
  game.ballReleaseTimer = 0;
  
  game.abilities.laser.count = 3;
  game.abilities.fireball.count = 2;
  game.abilities.multiball.count = 1;
  game.abilities.laser.active = false;
  game.abilities.fireball.active = false;
  game.abilities.multiball.active = false;
  
  createBricks();
  updateUI();
  updateAbilitiesMenu();
  hideAllMenus();
}

function createBall(x, y, angle, power = 1, type = 'normal') {
  const speed = 8 + power;
  
  let color, glow;
  if (type === 'laser') {
    color = '#00ffff';
    glow = 'rgba(0, 255, 255, 0.7)';
  } else if (type === 'fireball') {
    color = '#ff3300';
    glow = 'rgba(255, 100, 0, 0.7)';
  } else {
    color = '#ffff00';
    glow = 'rgba(255, 255, 0, 0.7)';
  }
  
  const ball = {
    x: x,
    y: y,
    radius: 5,
    vx: Math.cos(angle) * speed,
    vy: Math.sin(angle) * speed,
    color: color,
    glow: glow,
    trail: [],
    life: 500,
    type: type
  };
  
  game.balls.push(ball);
  game.activeBalls++;
  
  if (sounds.shoot) sounds.shoot();
  
  return ball;
}

function shootBalls(angle) {
  if (!game.canShoot || game.shotsUsed >= game.totalShots) return;
  
  game.shotsUsed++;
  game.canShoot = false;
  game.isShootingQueueActive = true;
  
  const machineX = canvas.width / 2;
  const machineY = canvas.height - 150;
  const spread = Math.PI / 6;
  
  game.shootingQueue = [];
  
  let ballType = 'normal';
  let power = 1;
  
  if (game.abilities.laser.active && game.abilities.laser.count > 0) {
    ballType = 'laser';
    power = 1.5;
  } else if (game.abilities.fireball.active && game.abilities.fireball.count > 0) {
    ballType = 'fireball';
    power = 2;
  }
  
  for (let i = 0; i < 15; i++) {
    const offset = (i / 14) - 0.5;
    const ballAngle = angle + (offset * spread * 0.5);
    
    game.shootingQueue.push({
      x: machineX,
      y: machineY,
      angle: ballAngle,
      power: power,
      type: ballType,
      abilityUsed: (game.abilities.laser.active || game.abilities.fireball.active) && i === 0
    });
  }
  
  if (game.abilities.multiball.active && game.abilities.multiball.count > 0) {
    for (let i = 0; i < 5; i++) {
      const offset = (i / 4) - 0.5;
      const ballAngle = angle + (offset * spread);
      game.shootingQueue.push({
        x: machineX,
        y: machineY,
        angle: ballAngle,
        power: 1,
        type: 'normal',
        abilityUsed: (i === 0)
      });
    }
  }
  
  game.ballReleaseTimer = game.ballReleaseDelay;
  updateUI();
}

function processShootingQueue() {
  if (game.shootingQueue.length > 0) {
    game.ballReleaseTimer--;
    
    if (game.ballReleaseTimer <= 0) {
      const ballInfo = game.shootingQueue.shift();
      createBall(ballInfo.x, ballInfo.y, ballInfo.angle, ballInfo.power, ballInfo.type);
      
      if (ballInfo.abilityUsed) {
        if (game.abilities.laser.active) {
          game.abilities.laser.count--;
          game.abilities.laser.active = false;
        } else if (game.abilities.fireball.active) {
          game.abilities.fireball.count--;
          game.abilities.fireball.active = false;
        } else if (game.abilities.multiball.active) {
          game.abilities.multiball.count--;
          game.abilities.multiball.active = false;
        }
        updateAbilitiesMenu();
      }
      
      game.ballReleaseTimer = game.ballReleaseDelay;
    }
  } else {
    game.isShootingQueueActive = false;
  }
}

function updateBalls() {
  if (game.isShootingQueueActive) {
    processShootingQueue();
  }
  
  game.bricks.forEach(brick => {
    if (brick.isWobbling) {
      brick.wobbleAngle += brick.wobbleSpeed;
      brick.wobble = Math.sin(brick.wobbleAngle) * 5;
      
      brick.wobbleSpeed *= 0.95;
      if (Math.abs(brick.wobbleSpeed) < 0.1) {
        brick.isWobbling = false;
        brick.wobble = 0;
      }
    }
    
    if (brick.hitTime > 0) {
      brick.hitTime--;
    }
  });
  
  for (let i = game.balls.length - 1; i >= 0; i--) {
    const ball = game.balls[i];
    
    ball.trail.push({x: ball.x, y: ball.y});
    if (ball.trail.length > 10) ball.trail.shift();
    
    ball.x += ball.vx;
    ball.y += ball.vy;
    
    if (ball.x - ball.radius < 10 || ball.x + ball.radius > canvas.width - 10) {
      ball.vx = -ball.vx;
    }
    if (ball.y - ball.radius < 10) {
      ball.vy = -ball.vy;
    }
    
    if (ball.y - ball.radius > canvas.height) {
      game.balls.splice(i, 1);
      game.activeBalls--;
      continue;
    }
    
    ball.life--;
    if (ball.life <= 0) {
      game.balls.splice(i, 1);
      game.activeBalls--;
      continue;
    }
    
    for (let j = game.bricks.length - 1; j >= 0; j--) {
      const brick = game.bricks[j];
      const brickX = brick.x + (brick.isWobbling ? brick.wobble : 0);
      
      if (ball.x + ball.radius > brickX &&
          ball.x - ball.radius < brickX + brick.width &&
          ball.y + ball.radius > brick.y &&
          ball.y - ball.radius < brick.y + brick.height) {
        
        const dx = (ball.x - (brickX + brick.width/2)) / (brick.width/2);
        const dy = (ball.y - (brick.y + brick.height/2)) / (brick.height/2);
        
        if (Math.abs(dx) > Math.abs(dy)) {
          ball.vx = -ball.vx;
        } else {
          ball.vy = -ball.vy;
        }
        
        let damage = 1;
        if (ball.type === 'laser') damage = 2;
        if (ball.type === 'fireball') damage = 3;
        
        brick.hp -= damage;
        brick.hitTime = 10;
        brick.isWobbling = true;
        brick.wobbleSpeed = 0.5;
        brick.wobbleAngle = 0;
        
        if (sounds.hit) {
          sounds.hit(300 + damage * 100);
        }
        
        game.score += damage * 10;
        
        for (let p = 0; p < 5; p++) {
          game.particles.push({
            x: ball.x,
            y: ball.y,
            vx: (Math.random() - 0.5) * 10,
            vy: (Math.random() - 0.5) * 10,
            color: ball.color,
            size: Math.random() * 3 + 2,
            life: 30
          });
        }
        
        if (brick.hp <= 0) {
          if (sounds.destroy) sounds.destroy();
          
          for (let p = 0; p < 15; p++) {
            game.particles.push({
              x: brick.x + brick.width/2,
              y: brick.y + brick.height/2,
              vx: (Math.random() - 0.5) * 15,
              vy: (Math.random() - 0.5) * 15,
              color: brick.color,
              size: Math.random() * 4 + 2,
              life: 50
            });
          }
          
          game.bricks.splice(j, 1);
          game.score += 100;
        }
        
        ball.x += ball.vx * 0.5;
        ball.y += ball.vy * 0.5;
        
        break;
      }
    }
  }
  
  for (let i = game.particles.length - 1; i >= 0; i--) {
    const p = game.particles[i];
    p.x += p.vx;
    p.y += p.vy;
    p.vy += 0.2;
    p.life--;
    if (p.life <= 0) {
      game.particles.splice(i, 1);
    }
  }
  
  if (game.balls.length === 0 && !game.isShootingQueueActive) {
    game.activeBalls = 0;
    game.canShoot = true;
  }
  
  if (game.bricks.length === 0 && game.balls.length === 0 && !game.isShootingQueueActive) {
    levelComplete();
  }
  
  if (game.shotsUsed >= game.totalShots && game.balls.length === 0 && game.bricks.length > 0 && !game.isShootingQueueActive) {
    gameOver();
  }
    }
    function draw3DBrick(brick) {
  const depth = 5;
  const brickX = brick.x + (brick.isWobbling ? brick.wobble : 0);
  const brickY = brick.y;
  
  ctx.fillStyle = brick.shadow;
  ctx.fillRect(brickX + 5, brickY + 5, brick.width, brick.height);
  
  ctx.fillStyle = brick.sideColor;
  ctx.beginPath();
  ctx.moveTo(brickX, brickY);
  ctx.lineTo(brickX - depth, brickY - depth);
  ctx.lineTo(brickX - depth, brickY + brick.height - depth);
  ctx.lineTo(brickX, brickY + brick.height);
  ctx.closePath();
  ctx.fill();
  
  ctx.fillStyle = brick.topColor;
  ctx.beginPath();
  ctx.moveTo(brickX, brickY);
  ctx.lineTo(brickX + brick.width, brickY);
  ctx.lineTo(brickX + brick.width - depth, brickY - depth);
  ctx.lineTo(brickX - depth, brickY - depth);
  ctx.closePath();
  ctx.fill();
  
  if (brick.hitTime > 0) {
    ctx.fillStyle = '#ffffff';
    ctx.globalAlpha = brick.hitTime / 10;
    ctx.fillRect(brickX, brickY, brick.width, brick.height);
    ctx.globalAlpha = 1;
  }
  
  ctx.fillStyle = brick.color;
  ctx.fillRect(brickX, brickY, brick.width, brick.height);
  
  ctx.strokeStyle = '#ffffff';
  ctx.lineWidth = 2;
  ctx.strokeRect(brickX, brickY, brick.width, brick.height);
  
  ctx.fillStyle = '#ffffff';
  ctx.font = 'bold 14px Arial';
  ctx.textAlign = 'center';
  ctx.textBaseline = 'middle';
  ctx.fillText(brick.hp, brickX + brick.width/2, brickY + brick.height/2);
  
  ctx.fillStyle = '#000000';
  ctx.fillText(brick.hp, brickX + brick.width/2 + 1, brickY + brick.height/2 + 1);
}

function draw() {
  ctx.fillStyle = '#000011';
  ctx.fillRect(0, 0, canvas.width, canvas.height);
  
  game.particles.forEach(p => {
    ctx.globalAlpha = p.life / 50;
    ctx.fillStyle = p.color;
    ctx.beginPath();
    ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
    ctx.fill();
  });
  ctx.globalAlpha = 1;
  
  game.bricks.forEach(brick => {
    draw3DBrick(brick);
  });
  
  game.balls.forEach(ball => {
    ball.trail.forEach((pos, index) => {
      ctx.globalAlpha = index / ball.trail.length * 0.5;
      ctx.fillStyle = ball.glow;
      ctx.beginPath();
      ctx.arc(pos.x, pos.y, ball.radius * (index / ball.trail.length), 0, Math.PI * 2);
      ctx.fill();
    });
    ctx.globalAlpha = 1;
    
    ctx.fillStyle = ball.glow;
    ctx.beginPath();
    ctx.arc(ball.x, ball.y, ball.radius + 2, 0, Math.PI * 2);
    ctx.fill();
    
    const gradient = ctx.createRadialGradient(
      ball.x, ball.y, 0,
      ball.x, ball.y, ball.radius
    );
    
    if (ball.type === 'laser') {
      gradient.addColorStop(0, '#ffffff');
      gradient.addColorStop(0.5, '#00ffff');
      gradient.addColorStop(1, '#0088ff');
    } else if (ball.type === 'fireball') {
      gradient.addColorStop(0, '#ffff00');
      gradient.addColorStop(0.5, '#ff3300');
      gradient.addColorStop(1, '#990000');
    } else {
      gradient.addColorStop(0, '#ffffff');
      gradient.addColorStop(0.5, '#ffff00');
      gradient.addColorStop(1, '#ffaa00');
    }
    
    ctx.fillStyle = gradient;
    ctx.beginPath();
    ctx.arc(ball.x, ball.y, ball.radius, 0, Math.PI * 2);
    ctx.fill();
    
    ctx.fillStyle = '#ffffff';
    ctx.globalAlpha = 0.8;
    ctx.beginPath();
    ctx.arc(ball.x - ball.radius/3, ball.y - ball.radius/3, ball.radius/3, 0, Math.PI * 2);
    ctx.fill();
    ctx.globalAlpha = 1;
  });
  
  if (game.aiming && game.canShoot) {
    const machineX = canvas.width / 2;
    const machineY = canvas.height - 150;
    
    ctx.strokeStyle = '#00ffff';
    ctx.lineWidth = 2;
    ctx.setLineDash([5, 5]);
    ctx.beginPath();
    ctx.moveTo(machineX, machineY);
    ctx.lineTo(
      machineX + Math.cos(game.aimAngle) * 200,
      machineY + Math.sin(game.aimAngle) * 200
    );
    ctx.stroke();
    ctx.setLineDash([]);
    
    ctx.fillStyle = '#ff0000';
    ctx.beginPath();
    ctx.arc(
      machineX + Math.cos(game.aimAngle) * 200,
      machineY + Math.sin(game.aimAngle) * 200,
      5, 0, Math.PI * 2
    );
    ctx.fill();
  }
  
  if (game.isShootingQueueActive && game.shootingQueue.length > 0) {
    const machineX = canvas.width / 2;
    const machineY = canvas.height - 150;
    
    ctx.fillStyle = 'rgba(255, 255, 0, 0.7)';
    ctx.font = 'bold 16px Arial';
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    ctx.fillText(`Balls in queue: ${game.shootingQueue.length}`, machineX, machineY - 30);
  }
}

function levelComplete() {
  game.state = 'complete';
  
  const shotsUsed = game.shotsUsed;
  const totalShots = game.totalShots;
  const efficiency = shotsUsed / totalShots;
  
  let stars = 1;
  if (efficiency <= 0.5) stars = 3;
  else if (efficiency <= 0.8) stars = 2;
  
  game.levelStars[game.currentLevel] = stars;
  
  if (game.currentLevel === game.maxUnlockedLevel) {
    game.maxUnlockedLevel = game.currentLevel + 1;
    if (sounds.unlock) sounds.unlock();
  }
  
  saveGameData();
  
  document.getElementById('completedLevel').textContent = game.currentLevel;
  document.getElementById('shotsUsed').textContent = shotsUsed;
  document.getElementById('totalShots').textContent = totalShots;
  
  const starElements = ['star1', 'star2', 'star3'];
  starElements.forEach((id, index) => {
    const star = document.getElementById(id);
    star.classList.remove('active', 'earned');
    
    if (index < stars) {
      setTimeout(() => {
        star.classList.add('earned');
        setTimeout(() => {
          star.classList.add('active');
        }, 800);
      }, index * 300);
    }
  });
  
  hideAllMenus();
  document.getElementById('completeMenu').style.display = 'block';
}

function gameOver() {
  game.state = 'gameOver';
  document.getElementById('finalScore').textContent = game.score;
  hideAllMenus();
  document.getElementById('gameOverMenu').style.display = 'block';
}

function hideAllMenus() {
  const menus = document.querySelectorAll('.menu');
  menus.forEach(menu => {
    menu.style.display = 'none';
  });
    }
    function generateLevelGrid() {
  const grid = document.getElementById('levelGrid');
  grid.innerHTML = '';
  
  for (let i = 1; i <= 1000; i++) {
    const btn = document.createElement('button');
    btn.className = 'level-btn';
    
    if (i > game.maxUnlockedLevel) {
      btn.classList.add('locked');
      btn.disabled = true;
      
      const lockIcon = document.createElement('div');
      lockIcon.className = 'lock-icon';
      lockIcon.textContent = 'ðŸ”’';
      btn.appendChild(lockIcon);
      
      const levelNumber = document.createElement('div');
      levelNumber.className = 'level-number';
      levelNumber.textContent = i;
      btn.appendChild(levelNumber);
    } else {
      if (i < game.currentLevel) {
        btn.classList.add('completed');
      }
      
      const levelNumber = document.createElement('div');
      levelNumber.className = 'level-number';
      levelNumber.textContent = i;
      btn.appendChild(levelNumber);
      
      if (game.levelStars[i]) {
        const starsContainer = document.createElement('div');
        starsContainer.className = 'level-stars';
        
        const starsEarned = game.levelStars[i];
        for (let s = 0; s < 3; s++) {
          const star = document.createElement('div');
          star.className = 'level-star';
          if (s < starsEarned) {
            star.classList.add('earned');
          } else {
            star.classList.add('empty');
          }
          starsContainer.appendChild(star);
        }
        
        btn.appendChild(starsContainer);
      }
      
      btn.addEventListener('click', () => {
        if (sounds.click) sounds.click();
        startLevel(i);
      });
    }
    
    if (i === game.maxUnlockedLevel && i > 1) {
      setTimeout(() => {
        btn.classList.add('unlock-animation');
        setTimeout(() => {
          btn.classList.remove('unlock-animation');
        }, 500);
      }, 100);
    }
    
    grid.appendChild(btn);
  }
}

function initEventListeners() {
  canvas.addEventListener('mousedown', (e) => {
    if (game.state !== 'playing' || !game.canShoot) return;
    
    game.mouseDown = true;
    game.aiming = true;
    updateAim(e);
  });
  
  canvas.addEventListener('mousemove', (e) => {
    if (!game.mouseDown) return;
    updateAim(e);
  });
  
  canvas.addEventListener('mouseup', (e) => {
    if (!game.mouseDown || !game.aiming) return;
    
    game.mouseDown = false;
    game.aiming = false;
    shootBalls(game.aimAngle);
  });
  
  canvas.addEventListener('touchstart', (e) => {
    e.preventDefault();
    if (game.state !== 'playing' || !game.canShoot) return;
    
    game.mouseDown = true;
    game.aiming = true;
    updateAim(e.touches[0]);
  });
  
  canvas.addEventListener('touchmove', (e) => {
    e.preventDefault();
    if (!game.mouseDown) return;
    updateAim(e.touches[0]);
  });
  
  canvas.addEventListener('touchend', (e) => {
    e.preventDefault();
    if (!game.mouseDown || !game.aiming) return;
    
    game.mouseDown = false;
    game.aiming = false;
    shootBalls(game.aimAngle);
  });
  
  function updateAim(event) {
    const machineX = canvas.width / 2;
    const machineY = canvas.height - 150;
    
    const rect = canvas.getBoundingClientRect();
    const x = event.clientX - rect.left;
    const y = event.clientY - rect.top;
    
    game.aimX = x;
    game.aimY = y;
    game.aimAngle = Math.atan2(y - machineY, x - machineX);
    
    const minAngle = -Math.PI + 0.3;
    const maxAngle = -0.3;
    game.aimAngle = Math.max(minAngle, Math.min(maxAngle, game.aimAngle));
  }
  
  document.getElementById('abilitiesBtn').addEventListener('click', () => {
    if (sounds.click) sounds.click();
    hideAllMenus();
    document.getElementById('abilitiesMenu').style.display = 'block';
    updateAbilitiesMenu();
  });
  
  document.getElementById('menuBtn').addEventListener('click', () => {
    if (sounds.click) sounds.click();
    hideAllMenus();
    document.getElementById('mainMenu').style.display = 'block';
  });
  
  document.getElementById('startBtn').addEventListener('click', () => {
    if (sounds.click) sounds.click();
    startLevel(1);
  });
  
  document.getElementById('continueBtn').addEventListener('click', () => {
    if (sounds.click) sounds.click();
    startLevel(game.currentLevel);
  });
  
  document.getElementById('levelSelectBtn').addEventListener('click', () => {
    if (sounds.click) sounds.click();
    generateLevelGrid();
    hideAllMenus();
    document.getElementById('levelMenu').style.display = 'block';
  });
  
  document.getElementById('soundToggle').addEventListener('click', () => {
    game.soundEnabled = !game.soundEnabled;
    document.getElementById('soundToggle').textContent = 
      game.soundEnabled ? 'SOUND: ON' : 'SOUND: OFF';
    if (sounds.click) sounds.click();
  });
  
  document.getElementById('backToMainBtn').addEventListener('click', () => {
    if (sounds.click) sounds.click();
    hideAllMenus();
    document.getElementById('startMenu').style.display = 'block';
  });
  
  document.getElementById('resumeBtn').addEventListener('click', () => {
    if (sounds.click) sounds.click();
    hideAllMenus();
    game.state = 'playing';
  });
  
  document.getElementById('restartBtn').addEventListener('click', () => {
    if (sounds.click) sounds.click();
    startLevel(game.currentLevel);
  });
  
  document.getElementById('mainMenuBtn').addEventListener('click', () => {
    if (sounds.click) sounds.click();
    hideAllMenus();
    document.getElementById('startMenu').style.display = 'block';
  });
  
  document.getElementById('laserBtn').addEventListener('click', () => {
    if (sounds.click) sounds.click();
    if (game.abilities.laser.count > 0) {
      game.abilities.fireball.active = false;
      game.abilities.multiball.active = false;
      game.abilities.laser.active = true;
      hideAllMenus();
      updateAbilitiesMenu();
    }
  });
  
  document.getElementById('fireballBtn').addEventListener('click', () => {
    if (sounds.click) sounds.click();
    if (game.abilities.fireball.count > 0) {
      game.abilities.laser.active = false;
      game.abilities.multiball.active = false;
      game.abilities.fireball.active = true;
      hideAllMenus();
      updateAbilitiesMenu();
    }
  });
  
  document.getElementById('multiballBtn').addEventListener('click', () => {
    if (sounds.click) sounds.click();
    if (game.abilities.multiball.count > 0) {
      game.abilities.laser.active = false;
      game.abilities.fireball.active = false;
      game.abilities.multiball.active = true;
      hideAllMenus();
      updateAbilitiesMenu();
    }
  });
  
  document.getElementById('closeAbilitiesBtn').addEventListener('click', () => {
    if (sounds.click) sounds.click();
    hideAllMenus();
  });
  
  document.getElementById('nextLevelBtn').addEventListener('click', () => {
    if (sounds.click) sounds.click();
    startLevel(game.currentLevel + 1);
  });
  
  document.getElementById('menuAfterCompleteBtn').addEventListener('click', () => {
    if (sounds.click) sounds.click();
    hideAllMenus();
    document.getElementById('startMenu').style.display = 'block';
  });
  
  document.getElementById('restartGameBtn').addEventListener('click', () => {
    if (sounds.click) sounds.click();
    startLevel(game.currentLevel);
  });
  
  document.getElementById('menuAfterGameOverBtn').addEventListener('click', () => {
    if (sounds.click) sounds.click();
    hideAllMenus();
    document.getElementById('startMenu').style.display = 'block';
  });
  
  window.addEventListener('resize', () => {
    initCanvas();
    createBricks();
  });
}

function gameLoop() {
  if (game.state === 'playing') {
    updateBalls();
  }
  draw();
  updateUI();
  requestAnimationFrame(gameLoop);
}

function initGame() {
  initCanvas();
  initAudio();
  loadGameData();
  initEventListeners();
  
  document.getElementById('startMenu').style.display = 'block';
  gameLoop();
}

window.addEventListener('load', initGame);
</script>
</body>
</html>
